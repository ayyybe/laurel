<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>Laurel</title>
<style>
input[type=range] { width: 500px; }
</style>
<script src="laurel_base64.js"></script>
<script src="PitchShifter.js"></script>
<script>

function initFilters(context, source) {
	var gainDb = -40.0;
	var bandSplit = [360,3600];

	var hBand = context.createBiquadFilter();
	hBand.type = "lowshelf";
	hBand.frequency.value = bandSplit[0];
	hBand.gain.value = gainDb;

	var hInvert = context.createGain();
	hInvert.gain.value = -1.0;

	var mBand = context.createGain();

	var lBand = context.createBiquadFilter();
	lBand.type = "highshelf";
	lBand.frequency.value = bandSplit[1];
	lBand.gain.value = gainDb;

	var lInvert = context.createGain();
	lInvert.gain.value = -1.0;

	source.connect(lBand);
	source.connect(mBand);
	source.connect(hBand);

	hBand.connect(hInvert);
	lBand.connect(lInvert);

	hInvert.connect(mBand);
	lInvert.connect(mBand);

	lGain = context.createGain();
	mGain = context.createGain();
	hGain = context.createGain();

	lBand.connect(lGain);
	mBand.connect(mGain);
	hBand.connect(hGain);

	var sum = context.createGain();
	lGain.connect(sum);
	mGain.connect(sum);
	hGain.connect(sum);

	shifter = new PitchShifter(context);

	sum.connect(shifter);

	shifter.connect(context.destination);
}

function init() {
	AudioContext = window.AudioContext || window.webkitAudioContext;
	context = new AudioContext();
	context.suspend();
	data = Uint8Array.from(atob(laurel_base64), c => c.charCodeAt(0));
	context.decodeAudioData(data.buffer, function(buffer) {
		source = context.createBufferSource();
		source.buffer = buffer;
		source.loop = true;
		source.start();
		initFilters(context, source);
	});
}

function play(ctrl) {
	ctrl.value = context.state!='suspended' ? "Click To Play" : "Click To Pause";
	context.state=='suspended' ? context.resume() : context.suspend();
}

function check(checked) {
	shifter.bypass = checked;
}

function change(value, type, ctrl) {
	value = parseFloat(value);
	document.getElementById(type).innerText = value.toFixed(2);
	switch(type)	{
		case 'rate': source.playbackRate.value = value; break;
		case 'pitch': shifter.pitchRatio = value; break;
		case 'lowGain': lGain.gain.value = value; break;
		case 'midGain': mGain.gain.value = value; break;
		case 'highGain': hGain.gain.value = value; break;
	}
}

</script>
<body onload=init()>
<h2>Laurel</h2>
<p>Yanny-Laurel debate-related Web Audio API pitch shifter</p>

<input type=button id=play value="Click To Play" onclick="play(this)"><br><br>

<input type=range value=1 step=0.01 min=0.5 max=1.5 oninput="change(this.value,'pitch')">
<label>Pitch <span id="pitch">1.00</span></label></input>
<label><input type=checkbox onchange="check(this.checked)">Bypass</label>
<br>

<input type=range value=1 step=0.01 min=0.5 max=1.5 oninput="change(this.value,'rate')">
<label>Rate <span id="rate">1.00</span></label></input><br>

<input type=range value=1 step=0.01 min=0 max=1 oninput="change(this.value, 'lowGain')">
<label>Low Gain <span id="lowGain">1.00</span></label></input><br>

<input type=range value=1 step=0.01 min=0 max=1 oninput="change(this.value, 'midGain')">
<label>Mid Gain <span id="midGain">1.00</span></label></input><br>

<input type=range value=1 step=0.01 min=0 max=1 oninput="change(this.value, 'highGain')">
<label>High Gain <span id="highGain">1.00</span></label></input><br>

<p><a href="https://github.com/joric/laurel">GitHub</a>
</body>
</html>
